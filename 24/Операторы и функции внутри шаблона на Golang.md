# Операторы и функции внутри шаблона на Golang

---
В данной статье мы рассмотрим операторы и функции при работе с шаблонами, которые предоставляет шаблонизатор от Go.

Мы уже использовали некоторые операторы в прошлой статье, а точнее `{{define}}`, `{{template}}` и `{{block}}`. Однако есть еще три оператора, которые можно использовать для управления отображением динамических данных на странице — `{{if}}` , `{{with}}` и `{{range}}`.

- Если .Foo содержит какой либо контент, тогда отображается содержимое из C1, в противном случае отображается содержимое из С2.
```xhtml
{{if .Foo}}
    <div>{{.C1}}</div>
{{else}}
    <div>{{.C2}}</div>
{{end}}
```
- Содержимое из структуры userdata передаётся в точку . и уже в теле оператора when  до его загружающего тега {{ end }} доступ к полям из структуры userdata выполняется сразу через точку .Name, чтобы не писать каждый раз .usernata.Name. Тут оператор when полностью схож с оператором when из языка программирования Python.
```xhtml
{{ when .userdata }}
    <b>Имя:</b> {{ .Name }},
    <b>Телефон:</b> {{ .Phone }},
    <b>Возраст:</b> {{ .Age }}
{{ else }}
    Нет данных!
{{ end }}
```
- Оператор range выполняет цикл по перебору данных из среза. Допустим у нас есть срез данных с клиентами и мы хотим вывести весь список клиентов на странице.
```xhtml
{{ range .clients }}
<div>
    <p>Имя: {{ .Name }}</p>
    <p>Бюджет: {{ .Money }}</p>
</div>
{{ else }}
    Нет данных!
{{ end }}
```
или 
```xhtml
{{ range $key, $client := .clients }}
<div>
    <p>Номер в списке: {{ $key }}</p>
    <p>Имя: {{ $client.Name }}</p>
    <p>Бюджет: {{ $client.Money }}</p>
</div>
{{ end }}
```
Пример нашей структуры и сраза с данными клиентов для `{{ range }}`:

```go
type Clients struct {
	Name string
	Money int
}

func main() {
    clients := []Clients{
        {Name: "Иван", Money: 100},
        {Name: "Андрей", Money: 1500},
        {Name: "Василий", Money: 500},
    }

    // тут у нас подготовка файлов шаблона и рендеринг.
}
```
Стоит отметить несколько моментов, связанных с данными операторами:

-   Для всех трех операторов, условие `{{else}}` необязательно. Например, можно написать `{{if .Foo}} C1 {{end}}`, если нет содержимого `C2`, которое нужно отобразить;
-   Пустыми значениями являются [false](https://golangify.com/go-for-if-else-switch#true-false "True False Golang"), 0, любой указатель [nil](https://golangify.com/nil "nil в golang") или значение [интерфейса](https://golangify.com/interface "Создать интерфейс в golang"), а также любой [массив](https://golangify.com/array), [срез](https://golangify.com/slice-array), [карта](https://golangify.com/map) или [строка](https://golangify.com/string) нулевой длины;
-   Важно отметить, что оператор `with` и `range` меняют содержимое `.` точки.

Пакет `html/template` также предоставляет некоторые функции, которые вы можете использовать для добавления дополнительной логики в шаблоны и управления тем, что отображается при рендеринге шаблона. Найти полный список функций можно [здесь](https://golang.org/pkg/text/template/#hdr-Functions).

Далее представлены самые важные **функции от шаблонизатора**:

| Функция                            | Описание                                                                                                 |
|------------------------------------|----------------------------------------------------------------------------------------------------------|
| ``` {{eq .Foo .Bar}} ```           | Возвращает true, если .Foo равно .Bar                                                                    |
| ```{{ne .Foo .Bar}}  ```           | Возвращает true, если .Foo не равно .Bar                                                                 |
| ```{{not .Foo}}    ```             | Возвращает булево отрицание .Foo                                                                         |
| ```{{or .Foo .Bar}}    ```         | Возвращает .Foo, если .Foo не пустое, в противном случае выдает .Bar                                     |
| ```{{index .Foo i}} ```            | Возвращает значение из .Foo по индексу i. Базовый тип .Foo должен быть картой, срезом или массивом       |
| ```{{printf "%s-%s" .Foo .Bar}}``` | Возвращает отформатированную строку, содержащую значения .Foo и .Bar. Работает так же, как fmt.Sprintf() |
| ``` {{len .Foo}}   ```             | Возвращает длину символов .Foo как integer                                                               |
| ```{{$bar := len .Foo}} ```        | Присваивает длину .Foo переменной шаблона $bar                                                           |

Последний ряд представляет собой пример **объявления переменной в шаблоне**. Переменные в шаблоне особенно полезны, если требуется сохранить результат из [функции](https://golangify.com/func) и использовать его в логике отображения шаблона. Названия переменных должны **начинаться со знака доллара** и содержать только буквенно-цифровые символы.

## Оператор with от golang шаблонизатора

Хорошей возможностью использовать оператор `{{with}}` является наш файл `show.page.tmpl`, который мы создали в предыдущем уроке.

Измените его структуру следующим образом:

```xhtml
{{template "base" .}}

{{define "title"}}Заметка #{{.Snippet.ID}}{{end}}

{{define "main"}}
    {{with .Snippet}}
    <div class='snippet'>
        <div class='metadata'>
            <strong>{{.Title}}</strong>
            <span>#{{.ID}}</span>
        </div>
        <pre><code>{{.Content}}</code></pre>
        <div class='metadata'>
            <time>Создан: {{.Created}}</time>
            <time>Срок: {{.Expires}}</time>
        </div>
    </div>
    {{end}}
{{end}}
```
Теперь между `{{with .Snippet}}` и его закрывающим тегом `{{end}}` содержимое точки `.` хранит в себе содержимое от структуры `Snippet`. По сути точка становится структурой `models.Snippet` вместо структуры `templateData` которая изначально хранилась в этой точки.

## Оператор if-else и range от шаблонизатора

В качестве примера давайте воспользуемся операторами `{{if}}` и `{{range}}` и обновим домашнюю страницу нашего **веб-приложения** для отображения таблицы с последними заметками. Результат будет выглядеть примерно следующим образом:

![Список всех заметок](https://golangify.com/wp-content/uploads/2021/09/snippets-list.jpg)

Сначала обновим структуру `templateData`, чтобы она содержала новое поле `Snippets` в ней будет срез со всеми заметками из **базы данных**. Сделаем это следующим образом:

```go
package main

import "golangify.com/snippetbox/pkg/models"

// Добавляем поле Snippets в структуру templateData
type templateData struct {
    Snippet  *models.Snippet
    Snippets []*models.Snippet
}
```
Затем обновляем обработчик `home`, чтобы он извлёк последние заметки из [модели базы данных](https://golangify.com/designing-a-database-model) и передал их в шаблон `home.page.tmpl`:

```go
func (app *application) home(w http.ResponseWriter, r *http.Request) {
    if r.URL.Path != "/" {
        app.notFound(w)
        return
    }

    s, err := app.snippets.Latest()
    if err != nil {
        app.serverError(w, err)
        return
    }

    // Создаем экземпляр структуры templateData,
    // содержащий срез с заметками.
    data := &templateData{Snippets: s}

    files := []string{
        "./ui/html/home.page.tmpl",
        "./ui/html/base.layout.tmpl",
        "./ui/html/footer.partial.tmpl",
    }

    ts, err := template.ParseFiles(files...)
    if err != nil {
        app.serverError(w, err)
        return
    }

    // Передаем структуру templateData в шаблонизатор.
    // Теперь она будет доступна внутри файлов шаблона через точку.
    err = ts.Execute(w, data)
    if err != nil {
        app.serverError(w, err)
    }
}
```
Теперь давайте перейдем к файлу `ui/html/home.page.tmpl` и обновим его содержимое для отображения этих заметок в таблице с помощью операторов `{{if}}` и `{{range}}`.

В частности:

-   Мы хотим использовать оператор `{{if}}`, чтобы проверить, содержится какие либо данные в срезе `snippets` или нет. Если он пуст, мы напишем пользователю следующее `Здесь ничего нет... пока что!`. В противном случае нужно отобразить таблицу, содержащую информацию о заметках;
-   Мы хотим использовать оператор `{{range}}` для перебора всех заметок в срезе и отображение их в виде таблицы.

Вот разметка:

```xhtml
{{template "base" .}}

{{define "title"}}Домашняя страница{{end}}

{{define "main"}}
    <h2>Последние Заметки</h2>
    {{if .Snippets}}
     <table>
        <tr>
            <th>Заголовок</th>
            <th>Создан</th>
            <th>ID</th>
        </tr>
        {{range .Snippets}}
        <tr>
            <td><a href='/snippet?id={{.ID}}'>{{.Title}}</a></td>
            <td>{{.Created}}</td>
            <td>#{{.ID}}</td>
        </tr>
        {{end}}
    </table>
    {{else}}
        <p>Здесь ничего нет... пока что!</p>
    {{end}}
{{end}}
```
Ниже будет приведен пример, чтобы вы знали как еще можно итерировать срез в шаблоне используя `{{ range }}` путем создания новых переменных `$key` и `$snippet`.

```xhtml
{{ range $key, $snippet := .Snippets }}
<tr>
    <td><a href='/snippet?id={{ $snippet.ID }}'>{{ $snippet.Title }}</a></td>
    <td>{{ $snippet.Created }}</td>
    <td>#{{ $snippet.ID }}</td>
</tr>
{{end}}
```
В нашем приложении мы будем использовать первый вариант, где данные заметки передаются сразу в `.` точку.

Убедитесь, что ваши файлы сохранены и перезапустите веб-приложение. Перейдите на страницу [http://127.0.0.1:4000](http://127.0.0.1:4000/) в браузере. Если все прошло по плану, вы должны увидеть страницу, похожую на следующую:

![Веб-приложение на Golang](https://golangify.com/wp-content/uploads/2021/09/slippets-list-final-1.png)

### Скачать исходный код

**Скачать**: [snippetbox-24](https://golangify.com/wp-content/uploads/2021/09/snippetbox-24.zip)

